<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Birthday Tree Pro</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Times New Roman', serif; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; align-items: center; padding-top: 40px; box-sizing: border-box; }
        #loader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s; }
        .loader-text { color: #d4af37; font-size: 14px; letter-spacing: 4px; margin-top: 20px; text-transform: uppercase; }
        .spinner { width: 40px; height: 40px; border: 1px solid rgba(212, 175, 55, 0.2); border-top: 1px solid #d4af37; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        h1 { color: #fceea7; font-size: 50px; margin: 0; letter-spacing: 6px; text-shadow: 0 0 30px rgba(252, 238, 167, 0.5); font-family: 'Cinzel', serif; }
        .upload-wrapper { margin-top: 20px; pointer-events: auto; }
        .upload-btn { background: rgba(30, 30, 30, 0.8); border: 1px solid #d4af37; color: #d4af37; padding: 10px 20px; cursor: pointer; font-size: 12px; letter-spacing: 2px; }
        #file-input { display: none; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
            "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
        }
    }
    </script>
</head>
<body>
    <div id="loader"><div class="spinner"></div><div class="loader-text">Loading Memories...</div></div>
    <div id="canvas-container"></div>
    <div id="ui-layer">
        <h1>Happy Birthday</h1>
        <div class="upload-wrapper">
            <label class="upload-btn">Add Photo<input type="file" id="file-input" multiple accept="image/*"></label>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';

        // 1. 配置信息
        const CONFIG = {
            colors: { gold: 0xffd966, pink: 0xffb6c1 },
            tree: { count: 1200, height: 24, radius: 8 }
        };

        let scene, camera, renderer, composer, mainGroup, clock = new THREE.Clock();
        let particleSystem = [], photoGroup = new THREE.Group();

        // 2. 初始化流程 (这是主入口)
        async function startApp() {
            initScene();
            createTree();
            createDefaultCard();
            
            // --- 这里整合“增添.docx”逻辑 ---
            loadMyImages(); 

            setupPostProcessing();
            setupWindowEvents();
            
            // 关闭加载遮罩
            const loader = document.getElementById('loader');
            if(loader) { loader.style.opacity = 0; setTimeout(() => loader.remove(), 800); }
            
            renderLoop();
        }

        // 3. 核心功能函数
        function initScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 50);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ReinhardToneMapping;
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            mainGroup = new THREE.Group();
            scene.add(mainGroup);
            mainGroup.add(photoGroup);

            const pmrem = new THREE.PMREMGenerator(renderer);
            scene.environment = pmrem.fromScene(new RoomEnvironment(), 0.04).texture;
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        }

        // --- 修正后的图片加载函数 ---
        function loadMyImages() {
            const pathList = [
                'images/1.jpg',
                'images/2.jpg',
                'images/3.jpg',
                'images/4.jpg',
                'images/5.jpg'
            ];
            const loader = new THREE.TextureLoader();
            pathList.forEach(url => {
                loader.load(
                    url, 
                    (tex) => { tex.colorSpace = THREE.SRGBColorSpace; addPhoto(tex); },
                    undefined,
                    () => console.log('Wait for image:', url)
                );
            });
        }

        function addPhoto(texture) {
            const g = new THREE.Group();
            const frame = new THREE.Mesh(
                new THREE.BoxGeometry(1.4, 1.4, 0.05),
                new THREE.MeshStandardMaterial({ color: CONFIG.colors.gold, metalness: 0.8 })
            );
            const photo = new THREE.Mesh(
                new THREE.PlaneGeometry(1.2, 1.2),
                new THREE.MeshBasicMaterial({ map: texture })
            );
            photo.position.z = 0.03;
            g.add(frame, photo);
            photoGroup.add(g);
            particleSystem.push(new PhotoObject(g));
        }

        // 粒子/照片动画类
        class PhotoObject {
            constructor(mesh) {
                this.mesh = mesh;
                this.pos = new THREE.Vector3();
                const t = Math.pow(Math.random(), 0.8);
                const a = t * 40 * Math.PI + Math.random() * Math.PI;
                const r = Math.max(0.5, CONFIG.tree.radius * (1 - t)) * (0.8 + Math.random() * 0.4);
                this.pos.set(Math.cos(a) * r, (t * CONFIG.tree.height) - 12, Math.sin(a) * r);
            }
            update(dt) {
                this.mesh.position.lerp(this.pos, 1.5 * dt);
                this.mesh.rotation.y += 0.4 * dt;
            }
        }

        function createTree() {
            const mat = new THREE.MeshStandardMaterial({color: CONFIG.colors.gold, metalness: 1});
            const geo = new THREE.SphereGeometry(0.2, 8, 8);
            for(let i=0; i<CONFIG.tree.count; i++) {
                const m = new THREE.Mesh(geo, mat);
                photoGroup.add(m);
                particleSystem.push(new PhotoObject(m));
            }
        }

        function createDefaultCard() {
            const can = document.createElement('canvas'); can.width=512; can.height=512;
            const ctx = can.getContext('2d'); ctx.fillStyle='#111'; ctx.fillRect(0,0,512,512);
            ctx.fillStyle='#d4af37'; ctx.font='bold 50px serif'; ctx.textAlign='center';
            ctx.fillText("BIRTHDAY", 256, 270);
            addPhoto(new THREE.CanvasTexture(can));
        }

        function setupPostProcessing() {
            composer = new EffectComposer(renderer);
            composer.addPass(new RenderPass(scene, camera));
            composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.6, 0.4, 0.85));
        }

        function setupWindowEvents() {
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            document.getElementById('file-input').addEventListener('change', (e) => {
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        new THREE.TextureLoader().load(ev.target.result, (t) => {
                            t.colorSpace = THREE.SRGBColorSpace; addPhoto(t);
                        });
                    };
                    reader.readAsDataURL(file);
                });
            });
        }

        function renderLoop() {
            requestAnimationFrame(renderLoop);
            const dt = clock.getDelta();
            mainGroup.rotation.y += 0.15 * dt;
            particleSystem.forEach(p => p.update(dt));
            composer.render();
        }

        // 启动应用
        startApp();
    </script>
</body>
</html>
